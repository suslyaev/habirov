{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —Å–º–µ—Ç–µ | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}





{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
{% if is_selected_action %}
&rsaquo; <a href="{% url 'admin:control_estimateitem_changelist' %}">{% trans 'Estimate items' %}</a>
&rsaquo; {% trans 'Create transactions for selected items' %}
{% else %}
&rsaquo; <a href="{% url 'admin:control_estimate_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; <a href="{% url 'admin:control_estimate_change' estimate.pk %}">{{ estimate|truncatechars:"18" }}</a>
&rsaquo; {% trans 'Create transactions' %}
{% endif %}
</div>
{% endblock %}

{% block content %}
{% if is_selected_action %}
<h1>–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π</h1>
{% else %}
<h1>–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —Å–º–µ—Ç–µ</h1>
{% endif %}

<div class="module aligned">
    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ—Ç–µ</h2>
    <div class="form-row">
        {% if is_selected_action %}
        <div><strong>–í—ã–±—Ä–∞–Ω–æ –ø–æ–∑–∏—Ü–∏–π:</strong> {{ items_data|length }}</div>
        {% if items_data %}
        <div><strong>–°–º–µ—Ç—ã:</strong> 
            {% for item_data in items_data %}
                {% if forloop.first %}{{ item_data.item.estimate }}{% endif %}
                {% if not forloop.last and item_data.item.estimate != items_data.0.item.estimate %}, {{ item_data.item.estimate }}{% endif %}
            {% endfor %}
        </div>
        {% endif %}
        {% else %}
        <div><strong>–°–º–µ—Ç–∞:</strong> {{ estimate }}</div>
        <div><strong>–≠—Ç–∞–ø:</strong> {{ estimate.stage }}</div>
        <div><strong>–û–±—ä–µ–∫—Ç:</strong> {{ estimate.stage.object }}</div>
        <div><strong>–ü—Ä–æ–µ–∫—Ç:</strong> {{ estimate.stage.object.project }}</div>
        {% endif %}
    </div>
</div>

<form method="post">
    {% csrf_token %}
    
    <div class="module aligned">
        <h2>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>
        <p class="help">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—É–º–º—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å–º–µ—Ç—ã.</p>
        
        {% for item_data in items_data %}
        <div class="form-row" style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <h3 style="margin: 0;">{{ item_data.item.get_item_name }}</h3>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                        <span id="total_sum_{{ item_data.item.id }}" style="font-weight: bold; color: #333;">
                            –û–±—â–∞—è —Å—É–º–º–∞: <span id="total_amount_{{ item_data.item.id }}">0.00</span> —Ä—É–±.
                        </span>
                    </div>
                </div>
                <div>
                    <label style="margin-right: 15px;">
                        <input type="checkbox" 
                               name="include_item_{{ item_data.item.id }}" 
                               value="1" 
                               {% if item_data.include_expense|default:True %}checked{% endif %}
                               onchange="toggleItemFields({{ item_data.item.id }}, this.checked)">
                        –í–∫–ª—é—á–∏—Ç—å –≤ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- –†–∞—Å—Ö–æ–¥ -->
                <div style="flex: 1; min-width: 300px;" id="expense_section_{{ item_data.item.id }}">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #dc3545; margin: 0 10px 0 0;">üí∏ –†–∞—Å—Ö–æ–¥</h4>
                        <label>
                            <input type="checkbox" 
                                   name="include_expense_{{ item_data.item.id }}" 
                                   value="1" 
                                   {% if item_data.include_expense|default:True %}checked{% endif %}
                                   onchange="toggleExpenseFields({{ item_data.item.id }}, this.checked)">
                            –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
                        </label>
                    </div>
                    <div class="form-row" id="expense_amount_row_{{ item_data.item.id }}">
                        <label for="expense_amount_{{ item_data.item.id }}">–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞:</label>
                        <input type="number" 
                               name="expense_amount_{{ item_data.item.id }}" 
                               id="expense_amount_{{ item_data.item.id }}"
                               value="{{ item_data.expense_amount }}"
                               step="0.01" 
                               min="0"
                               style="width: 120px;">
                        <span>—Ä—É–±.</span>
                    </div>
                    <div class="form-row" id="expense_category_row_{{ item_data.item.id }}">
                        <label for="expense_category_{{ item_data.item.id }}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞:</label>
                        <select name="expense_category_{{ item_data.item.id }}" 
                                id="expense_category_{{ item_data.item.id }}"
                                style="width: 200px;">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row" id="expense_contractor_row_{{ item_data.item.id }}">
                        <label for="expense_contractor_{{ item_data.item.id }}">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —Ä–∞—Å—Ö–æ–¥–∞:</label>
                        <select name="expense_contractor_{{ item_data.item.id }}" 
                                id="expense_contractor_{{ item_data.item.id }}"
                                style="width: 200px;">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ --</option>
                            {% for contractor in contractors %}
                            <option value="{{ contractor.id }}">{{ contractor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- –î–æ—Ö–æ–¥ -->
                <div style="flex: 1; min-width: 300px;" id="income_section_{{ item_data.item.id }}">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        {% if item_data.item.income_type %}
                        <h4 style="color: #28a745; margin: 0 10px 0 0;">üí∞ –î–æ—Ö–æ–¥ ({{ item_data.item.get_income_display }})</h4>
                        {% else %}
                        <h4 style="color: #28a745; margin: 0 10px 0 0;">üí∞ –î–æ—Ö–æ–¥ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π)</h4>
                        {% endif %}
                        <label>
                            <input type="checkbox" 
                                   name="include_income_{{ item_data.item.id }}" 
                                   value="1" 
                                   {% if item_data.include_income|default:item_data.item.income_type %}checked{% endif %}
                                   onchange="toggleIncomeFields({{ item_data.item.id }}, this.checked)">
                            –í–∫–ª—é—á–∏—Ç—å –¥–æ—Ö–æ–¥
                        </label>
                    </div>
                    <div class="form-row" id="income_amount_row_{{ item_data.item.id }}">
                        <label for="income_amount_{{ item_data.item.id }}">–°—É–º–º–∞ –¥–æ—Ö–æ–¥–∞:</label>
                        <input type="number" 
                               name="income_amount_{{ item_data.item.id }}" 
                               id="income_amount_{{ item_data.item.id }}"
                               value="{% if item_data.item.income_type %}{{ item_data.income_amount }}{% else %}0{% endif %}"
                               step="0.01" 
                               min="0"
                               style="width: 120px;">
                        <span>—Ä—É–±.</span>
                    </div>
                    <div class="form-row" id="income_category_row_{{ item_data.item.id }}">
                        <label for="income_category_{{ item_data.item.id }}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ—Ö–æ–¥–∞:</label>
                        <select name="income_category_{{ item_data.item.id }}" 
                                id="income_category_{{ item_data.item.id }}"
                                style="width: 200px;">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row" id="income_contractor_row_{{ item_data.item.id }}">
                        <label for="income_contractor_{{ item_data.item.id }}">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –¥–æ—Ö–æ–¥–∞:</label>
                        <select name="income_contractor_{{ item_data.item.id }}" 
                                id="income_contractor_{{ item_data.item.id }}"
                                style="width: 200px;">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ --</option>
                            {% for contractor in contractors %}
                            <option value="{{ contractor.id }}">{{ contractor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if not item_data.item.income_type %}
                    <div class="form-row" id="income_description_row_{{ item_data.item.id }}">
                        <label for="income_description_{{ item_data.item.id }}">–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–∞:</label>
                        <input type="text" 
                               name="income_description_{{ item_data.item.id }}" 
                               id="income_description_{{ item_data.item.id }}"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –ü—Ä–µ–º–∏—è –∏ —Ç.–¥."
                               style="width: 300px;">
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px;">
                <strong>–î–µ—Ç–∞–ª–∏:</strong>
                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ item_data.item.quantity }} {{ item_data.item.get_unit }} | 
                –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É: {{ item_data.item.unit_price }} —Ä—É–±. | 
                –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: {{ item_data.item.base_price }} —Ä—É–±. | 
                –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞: {{ item_data.item.client_price }} —Ä—É–±. | 
                –î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: {{ item_data.item.contractor_price }} —Ä—É–±.

            </div>
        </div>
        {% empty %}
        <p style="color: #6c757d; font-style: italic;">–í —Å–º–µ—Ç–µ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.</p>
        {% endfor %}
    </div>
    
    <div class="submit-row">
        <input type="submit" value="‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏" class="default" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold;">
        {% if is_selected_action %}
        <a href="{% url 'admin:control_estimateitem_changelist' %}" class="button" style="background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin-left: 10px;">‚ùå –û—Ç–º–µ–Ω–∞</a>
        {% else %}
        <a href="{% url 'admin:control_estimate_change' estimate.pk %}" class="button" style="background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin-left: 10px;">‚ùå –û—Ç–º–µ–Ω–∞</a>
        {% endif %}
    </div>
</form>

<style>
.form-row {
    margin: 10px 0;
}
.form-row label {
    display: inline-block;
    width: 150px;
    font-weight: bold;
}
.form-row input, .form-row select {
    margin: 0 5px;
}
.submit-row {
    margin: 20px 0;
    padding: 20px 0;
    border-top: 1px solid #ddd;
}
.disabled-section {
    opacity: 0.5;
    pointer-events: none;
}

</style>

<script>
function toggleItemFields(itemId, enabled) {
    const expenseSection = document.getElementById('expense_section_' + itemId);
    const incomeSection = document.getElementById('income_section_' + itemId);
    
    if (enabled) {
        expenseSection.classList.remove('disabled-section');
        if (incomeSection) incomeSection.classList.remove('disabled-section');
    } else {
        expenseSection.classList.add('disabled-section');
        if (incomeSection) incomeSection.classList.add('disabled-section');
    }
}

function toggleExpenseFields(itemId, enabled) {
    const amountRow = document.getElementById('expense_amount_row_' + itemId);
    const categoryRow = document.getElementById('expense_category_row_' + itemId);
    const contractorRow = document.getElementById('expense_contractor_row_' + itemId);
    
    if (enabled) {
        amountRow.classList.remove('disabled-section');
        categoryRow.classList.remove('disabled-section');
        if (contractorRow) contractorRow.classList.remove('disabled-section');
    } else {
        amountRow.classList.add('disabled-section');
        categoryRow.classList.add('disabled-section');
        if (contractorRow) contractorRow.classList.add('disabled-section');
    }
}

function toggleIncomeFields(itemId, enabled) {
    const amountRow = document.getElementById('income_amount_row_' + itemId);
    const categoryRow = document.getElementById('income_category_row_' + itemId);
    const contractorRow = document.getElementById('income_contractor_row_' + itemId);
    const descriptionRow = document.getElementById('income_description_row_' + itemId);
    
    if (enabled) {
        amountRow.classList.remove('disabled-section');
        categoryRow.classList.remove('disabled-section');
        if (contractorRow) contractorRow.classList.remove('disabled-section');
        if (descriptionRow) descriptionRow.classList.remove('disabled-section');
    } else {
        amountRow.classList.add('disabled-section');
        categoryRow.classList.add('disabled-section');
        if (contractorRow) contractorRow.classList.add('disabled-section');
        if (descriptionRow) descriptionRow.classList.add('disabled-section');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    {% for item_data in items_data %}
    toggleItemFields({{ item_data.item.id }}, document.querySelector('input[name="include_item_{{ item_data.item.id }}"]').checked);
    toggleExpenseFields({{ item_data.item.id }}, document.querySelector('input[name="include_expense_{{ item_data.item.id }}"]').checked);
    {% if item_data.item.income_type %}
    toggleIncomeFields({{ item_data.item.id }}, document.querySelector('input[name="include_income_{{ item_data.item.id }}"]').checked);
    {% endif %}
    {% endfor %}
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Select2 –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    initSelect2();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å—á–µ—Ç —Å—É–º–º
    initAmountCalculation();
});

function initSelect2() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Select2 –¥–ª—è –≤—Å–µ—Ö select –ø–æ–ª–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
    const allSelects = document.querySelectorAll('select[name*="category"], select[name*="contractor"]');
    allSelects.forEach(function(select) {
        if (window.jQuery) {
            const placeholder = select.name.includes('category') ? '-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --' : '-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ --';
            window.jQuery(select).select2({
                placeholder: placeholder,
                allowClear: true,
                width: '200px',
                language: 'ru'
            });
        }
    });
}

function initAmountCalculation() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—É–º–º
    {% for item_data in items_data %}
    const expenseInput{{ item_data.item.id }} = document.getElementById('expense_amount_{{ item_data.item.id }}');
    const incomeInput{{ item_data.item.id }} = document.getElementById('income_amount_{{ item_data.item.id }}');
    const expenseCheckbox{{ item_data.item.id }} = document.querySelector('input[name="include_expense_{{ item_data.item.id }}"]');
    const incomeCheckbox{{ item_data.item.id }} = document.querySelector('input[name="include_income_{{ item_data.item.id }}"]');
    
    if (expenseInput{{ item_data.item.id }}) {
        expenseInput{{ item_data.item.id }}.addEventListener('input', function() {
            calculateTotal({{ item_data.item.id }});
        });
    }
    
    if (incomeInput{{ item_data.item.id }}) {
        incomeInput{{ item_data.item.id }}.addEventListener('input', function() {
            calculateTotal({{ item_data.item.id }});
        });
    }
    
    if (expenseCheckbox{{ item_data.item.id }}) {
        expenseCheckbox{{ item_data.item.id }}.addEventListener('change', function() {
            calculateTotal({{ item_data.item.id }});
        });
    }
    
    if (incomeCheckbox{{ item_data.item.id }}) {
        incomeCheckbox{{ item_data.item.id }}.addEventListener('change', function() {
            calculateTotal({{ item_data.item.id }});
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å—á–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    calculateTotal({{ item_data.item.id }});
    {% endfor %}
}

function calculateTotal(itemId) {
    const expenseInput = document.getElementById('expense_amount_' + itemId);
    const incomeInput = document.getElementById('income_amount_' + itemId);
    const expenseCheckbox = document.querySelector('input[name="include_expense_' + itemId + '"]');
    const incomeCheckbox = document.querySelector('input[name="include_income_' + itemId + '"]');
    const totalElement = document.getElementById('total_amount_' + itemId);
    
    if (!totalElement) return;
    
    let total = 0;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
    if (expenseInput && expenseCheckbox && expenseCheckbox.checked) {
        const expenseValue = parseFloat(expenseInput.value) || 0;
        total += expenseValue;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Ö–æ–¥, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
    if (incomeInput && incomeCheckbox && incomeCheckbox.checked) {
        const incomeValue = parseFloat(incomeInput.value) || 0;
        total += incomeValue;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    totalElement.textContent = total.toFixed(2);
    
    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—É–º–º—ã
    const totalSumElement = document.getElementById('total_sum_' + itemId);
    if (totalSumElement) {
        if (total > 0) {
            totalSumElement.style.color = '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
        } else {
            totalSumElement.style.color = '#6c757d'; // –°–µ—Ä—ã–π
        }
    }
}


</script>
{% endblock %}
