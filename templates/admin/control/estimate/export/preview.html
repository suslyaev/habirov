{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}–°–º–µ—Ç–∞ | {{ estimate.stage.object }}{% endblock %}

{% block content %}
<h1 class="screen-title">{{ estimate.stage }}</h1>
<h1 class="print-only" style="display:none;">{{ estimate.stage }}</h1>
<p class="audience-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è: {% if audience == 'self' %}–î–ª—è —Å–µ–±—è{% elif audience == 'contractor' %}–î–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è{% else %}–î–ª—è –∫–ª–∏–µ–Ω—Ç–∞{% endif %}</p>

<style>
.export-table { width: 100%; table-layout: fixed; }
.export-table colgroup col:nth-child(1) { width: 45%; }
.export-table colgroup col:nth-child(2) { width: 12%; }
.export-table colgroup col:nth-child(3) { width: 10%; }
.export-table colgroup col:nth-child(4) { width: 15%; }
.export-table colgroup col:nth-child(5) { width: 14%; }
.export-table colgroup col:nth-child(6) { width: 4%; }
.num { text-align: right; }
.muted { color:#666; }
.ctrl { margin: 10px 0; }
.ctrl .button { margin-left: 8px; }
input[type=number] { width: 100%; box-sizing: border-box; }
input[type=text] { width: 100%; box-sizing: border-box; }
tfoot td { font-weight: 600; }
.num input { text-align: right; }
.print-only { display: none; }
.print-val { display: none; }
/* –ü–µ—á–∞—Ç—å: —Å–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-—Ö—Ä–æ–º –∏ –∫–Ω–æ–ø–∫–∏ */
@media print {
  #header, .breadcrumbs, .object-tools, .submit-row, .ctrl { display: none !important; }
  .audience-label, .screen-title { display: none !important; }
  .print-only { display: block !important; }
  input, textarea, select { display: none !important; }
  .print-val { display: inline !important; }
  /* —É–±—Ä–∞—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä—ã —É —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ç–µ–∫—Å—Ç */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }
  /* —Å–∫—Ä—ã—Ç—å –∏–∫–æ–Ω–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –≤ –ø–µ—á–∞—Ç–∏ */
  .del-row, .del-extra { display: none !important; }
  /* –Ω–∞ –ø–µ—á–∞—Ç–∏ —á–∏—Å–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏ —á–µ—Ä–µ–∑ data-value */
  .qty, .extra-qty, .extra-price { appearance: none; }
}
</style>

<h2>–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
<table class="listing export-table" id="tbl-materials">
  <colgroup>
    <col><col><col><col><col><col>
  </colgroup>
  <thead>
    <tr>
      <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
      <th>–ï–¥.</th>
      <th class="num">–ö–æ–ª-–≤–æ</th>
      <th class="num">–¶–µ–Ω–∞</th>
      <th class="num">–°—É–º–º–∞</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in materials_data %}
    <tr>
      <td>{{ item.name }}</td>
      <td>{{ item.unit }}</td>
      <td class="num"><span class="qty" data-value="{{ item.quantity|floatformat:2 }}">{{ item.quantity|floatformat:2 }}</span></td>
      <td class="num"><input type="number" class="unit-price" value="{{ item.unit_price_str }}" step="0.01" min="0"><span class="print-val price-print">{{ item.unit_price_str }}</span></td>
      <td class="num total">{{ item.total_str }}</td>
      <td class="num"><a href="#" class="del-row" title="–£–¥–∞–ª–∏—Ç—å">üóë</a></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4" class="num">–ò—Ç–æ–≥–æ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º:</td>
      <td class="num" id="sum-materials">{{ total_materials_str }}</td>
    </tr>
  </tfoot>
</table>
<div class="ctrl">
  <button type="button" class="button" id="add-material-row">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
  <span class="muted">(–≤ —Ä–∞–∑–¥–µ–ª –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤)</span>
</div>

<h2>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç</h2>
<table class="listing export-table" id="tbl-works">
  <colgroup>
    <col><col><col><col><col><col>
  </colgroup>
  <thead>
    <tr>
      <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
      <th>–ï–¥.</th>
      <th class="num">–ö–æ–ª-–≤–æ</th>
      <th class="num">–¶–µ–Ω–∞</th>
      <th class="num">–°—É–º–º–∞</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in works_data %}
    <tr>
      <td>{{ item.name }}</td>
      <td>{{ item.unit }}</td>
      <td class="num"><span class="qty" data-value="{{ item.quantity|floatformat:2 }}">{{ item.quantity|floatformat:2 }}</span></td>
      <td class="num"><input type="number" class="unit-price" value="{{ item.unit_price_str }}" step="0.01" min="0"><span class="print-val price-print">{{ item.unit_price_str }}</span></td>
      <td class="num total">{{ item.total_str }}</td>
      <td class="num"><a href="#" class="del-row" title="–£–¥–∞–ª–∏—Ç—å">üóë</a></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4" class="num">–ò—Ç–æ–≥–æ –ø–æ —Ä–∞–±–æ—Ç–∞–º:</td>
      <td class="num" id="sum-works">{{ total_works_str }}</td>
    </tr>
  </tfoot>
</table>
<div class="ctrl">
  <button type="button" class="button" id="add-work-row">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
  <span class="muted">(–≤ —Ä–∞–∑–¥–µ–ª —Ä–∞–±–æ—Ç)</span>
</div>

<div id="extras-section">
<h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</h2>
<table class="listing export-table" id="tbl-extras">
  <colgroup>
    <col><col><col><col><col><col>
  </colgroup>
  <thead>
    <tr>
      <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
      <th class="muted">–ï–¥.</th>
      <th class="muted num">–ö–æ–ª-–≤–æ</th>
      <th class="num">–¶–µ–Ω–∞</th>
      <th class="num">–°—É–º–º–∞</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4" class="num">–ò—Ç–æ–≥–æ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã:</td>
      <td class="num" id="sum-extras">0.00</td>
      <td></td>
    </tr>
  </tfoot>
</table>
<div class="ctrl">
  <button type="button" class="button" id="add-extra">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
</div>
</div>

<h2>–ò—Ç–æ–≥–æ</h2>
<p style="text-align:right; font-size:16px; font-weight:700;">–û–±—â–∞—è —Å—É–º–º–∞: <span id="sum-overall">{{ overall_total_str }}</span></p>

<div class="submit-row" style="margin-top:12px;">
  <a href="{% url 'admin:control_estimate_export' estimate.pk %}" class="button">–ù–∞–∑–∞–¥</a>
  <a href="#" class="button" onclick="handlePrint(); return false;">–ü–µ—á–∞—Ç—å</a>
  <a href="{% url 'admin:control_estimate_change' estimate.pk %}" class="button">–ó–∞–∫—Ä—ã—Ç—å</a>
  </div>
<script>
(function(){
  function recalcTable(tblId, sumCellId){
    var tbl = document.getElementById(tblId); if(!tbl) return 0;
    var sum = 0;
    tbl.querySelectorAll('tbody tr').forEach(function(tr){
      var qtyEl = tr.querySelector('.qty');
      var qtyInp = tr.querySelector('.qty-input');
      var upEl = tr.querySelector('.unit-price');
      var totalEl = tr.querySelector('.total');
      var qty = qtyInp ? (parseFloat(qtyInp.value.replace(',', '.'))||0) : (parseFloat(qtyEl && qtyEl.getAttribute('data-value'))||0);
      var up = parseFloat(upEl && upEl.value) || 0;
      var total = qty * up;
      if (qtyEl) { qtyEl.setAttribute('data-value', qty.toFixed(2)); qtyEl.textContent = qty.toFixed(2); }
      if (totalEl) totalEl.textContent = total.toFixed(2);
      sum += total;
    });
    var cell = document.getElementById(sumCellId); if(cell) cell.textContent = sum.toFixed(2);
    return sum;
  }
  function recalcExtras(){
    var tbl = document.getElementById('tbl-extras'); if(!tbl) return 0;
    var sum = 0;
    tbl.querySelectorAll('tbody tr').forEach(function(tr){
      var qty = parseFloat((tr.querySelector('.extra-qty')||{}).value?.toString().replace(',', '.')) || 0;
      var price = parseFloat((tr.querySelector('.extra-price')||{}).value?.toString().replace(',', '.')) || 0;
      var total = qty * price;
      var totalEl = tr.querySelector('.extra-total'); if (totalEl) totalEl.textContent = total.toFixed(2);
      sum += total;
    });
    var cell = document.getElementById('sum-extras'); if(cell) cell.textContent = sum.toFixed(2);
    return sum;
  }
  function recalcAll(){
    var m = recalcTable('tbl-materials','sum-materials');
    var w = recalcTable('tbl-works','sum-works');
    var e = recalcExtras();
    var overall = document.getElementById('sum-overall');
    if (overall) overall.textContent = (m + w + e).toFixed(2);
  }
  function bindInputs(){
    document.querySelectorAll('.unit-price').forEach(function(inp){
      inp.addEventListener('input', function(){
        var v = parseFloat((inp.value||'').toString().replace(',', '.')) || 0;
        var span = inp.parentElement.querySelector('.price-print');
        if (span) span.textContent = v.toFixed(2);
        recalcAll();
      });
      inp.addEventListener('change', function(){
        var v = parseFloat((inp.value||'').toString().replace(',', '.')) || 0;
        var span = inp.parentElement.querySelector('.price-print');
        if (span) span.textContent = v.toFixed(2);
        recalcAll();
      });
    });
    document.querySelectorAll('.del-row').forEach(function(a){
      a.addEventListener('click', function(e){ e.preventDefault(); var tr=this.closest('tr'); tr?.remove(); recalcSums(); });
    });
  }
  
  function recalcSums(){
    // –ü–µ—Ä–µ—Å—á–µ—Ç —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã—Ö —Å—É–º–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö total –∑–Ω–∞—á–µ–Ω–∏–π
    var sumM = 0, sumW = 0;
    document.querySelectorAll('#tbl-materials tbody tr').forEach(function(tr){
      var total = parseFloat(tr.querySelector('.total')?.textContent) || 0;
      sumM += total;
    });
    document.querySelectorAll('#tbl-works tbody tr').forEach(function(tr){
      var total = parseFloat(tr.querySelector('.total')?.textContent) || 0;
      sumW += total;
    });
    var sumE = recalcExtras();
    var cellM = document.getElementById('sum-materials');
    var cellW = document.getElementById('sum-works');
    var overall = document.getElementById('sum-overall');
    if (cellM) cellM.textContent = sumM.toFixed(2);
    if (cellW) cellW.textContent = sumW.toFixed(2);
    if (overall) overall.textContent = (sumM + sumW + sumE).toFixed(2);
  }
  function addExtraRow(){
    var tbody = document.querySelector('#tbl-extras tbody');
    if(!tbody) return;
    var tr = document.createElement('tr');
    tr.innerHTML = '<td><input type="text" class="extra-name" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"/><span class="print-val extra-name-print"></span></td>'+
                   '<td class="muted"></td>'+
                   '<td class="num"><input type="number" class="extra-qty" step="0.01" min="0" value="1"/><span class="print-val extra-qty-print">1.00</span></td>'+
                   '<td class="num"><input type="number" class="extra-price" step="0.01" min="0" value="0.00"/><span class="print-val extra-price-print">0.00</span></td>'+
                   '<td class="num extra-total">0.00</td>'+
                   '<td><a href="#" class="del-extra" title="–£–¥–∞–ª–∏—Ç—å">üóë</a></td>';
    tbody.appendChild(tr);
    tr.querySelector('.extra-name').addEventListener('input', function(){
      var s = tr.querySelector('.extra-name-print'); if (s) s.textContent = this.value || '';
    });
    tr.querySelector('.extra-qty').addEventListener('input', function(){
      var v = parseFloat((this.value||'').toString().replace(',', '.')) || 0;
      var s = tr.querySelector('.extra-qty-print'); if (s) s.textContent = v.toFixed(2);
      recalcAll();
    });
    tr.querySelector('.extra-price').addEventListener('input', function(){
      var v = parseFloat((this.value||'').toString().replace(',', '.')) || 0;
      var s = tr.querySelector('.extra-price-print'); if (s) s.textContent = v.toFixed(2);
      recalcAll();
    });
    tr.querySelector('.del-extra').addEventListener('click', function(e){ e.preventDefault(); tr.remove(); recalcAll(); });
    recalcAll();
  }
  function addRowTo(tableId){
    var tbody = document.querySelector('#'+tableId+' tbody'); if(!tbody) return;
    var tr = document.createElement('tr');
    tr.innerHTML = '<td><input type="text" class="name-input" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"/><span class="print-val name-print"></span></td>'+
                   '<td><input type="text" class="unit-input" placeholder="–µ–¥."/></td>'+
                   '<td class="num"><input type="number" class="qty-input" step="0.01" min="0" value="1"/><span class="print-val qty-print">1.00</span></td>'+
                   '<td class="num"><input type="number" class="unit-price" step="0.01" min="0" value="0.00"/><span class="print-val price-print">0.00</span></td>'+
                   '<td class="num total">0.00</td>'+
                   '<td class="num"><a href="#" class="del-row" title="–£–¥–∞–ª–∏—Ç—å">üóë</a></td>';
    tbody.appendChild(tr);
    tr.querySelector('.name-input').addEventListener('input', function(){
      var s = tr.querySelector('.name-print'); if (s) s.textContent = this.value || '';
    });
    tr.querySelector('.qty-input').addEventListener('input', function(){
      var v = parseFloat((this.value||'').toString().replace(',', '.')) || 0;
      var s = tr.querySelector('.qty-print'); if (s) s.textContent = v.toFixed(2);
      recalcAll();
    });
    tr.querySelector('.unit-price').addEventListener('input', function(){
      var v = parseFloat((this.value||'').toString().replace(',', '.')) || 0;
      var s = tr.querySelector('.price-print'); if (s) s.textContent = v.toFixed(2);
      recalcAll();
    });
    tr.querySelector('.del-row').addEventListener('click', function(e){ e.preventDefault(); tr.remove(); recalcAll(); });
    recalcAll();
  }
  document.getElementById('add-extra')?.addEventListener('click', addExtraRow);
  document.getElementById('add-material-row')?.addEventListener('click', function(){ addRowTo('tbl-materials'); });
  document.getElementById('add-work-row')?.addEventListener('click', function(){ addRowTo('tbl-works'); });
  bindInputs();
  recalcSums();  // –ò—Å–ø–æ–ª—å–∑—É–µ–º recalcSums –≤–º–µ—Å—Ç–æ recalcAll –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
})();
function handlePrint(){
  var extras = document.getElementById('extras-section');
  var tbody = document.querySelector('#tbl-extras tbody');
  var hadExtras = true;
  if (extras && tbody && tbody.children.length === 0) {
    hadExtras = false;
    extras.style.display = 'none';
  }
  window.print();
  // –≤–µ—Ä–Ω—É—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏
  if (!hadExtras && extras) { extras.style.display = ''; }
}
</script>
{% endblock %}


